name: Uninstall and Delete ACS resources

on:
  workflow_dispatch:
    inputs:
      sure:
          description: 'are you Sure to uninstall ACS? yes or no'
          required: true
          type: string

permissions:
  contents: read

jobs:
  Uninstall:
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        shell: bash
    
    steps:
    - name: Check if sure to uninstall ACS
      run: |
        if [ "${{ inputs.sure }}" != "yes" ]; then
          echo "Uninstallation cancelled."
          exit 1
        fi
        
    - name: Uninstall ACS Helm Chart
      run: helm uninstall acs --namespace $NAMESPACE  
    - name: Uninstall ACS Ingress Helm Chart
      run: helm uninstall acs-ingress-$EKS_CLUSTER_NAME -n $NAMESPACE  
    - name: Delete all PVCs
      run: kubectl delete pvc --all -n $NAMESPACE  
    - name: Delete all ConfigMaps
      run: kubectl delete configmap --all -n $NAMESPACE  
    - name: Delete all Secrets
      run: kubectl delete secret --all -n $NAMESPACE  
    - name: Destroy Terraform resources
      id: destroy
      working-directory: ./Terraform
      run: terraform destroy -auto-approve